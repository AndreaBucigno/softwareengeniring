<?php
/**
 * SCRIPT AUTOMATICO CONTROLLO SCADENZE
 * 
 * Questo script controlla automaticamente le scadenze e invia email di notifica
 * Deve essere eseguito tramite cron job giornaliero
 * 
 * Esempio cron job (esegue ogni giorno alle 09:00):
 * 0 9 * * * /usr/bin/php /path/to/your/project/scadenze_checker.php
 */

use PHPMailer\PHPMailer\PHPMailer;
use PHPMailer\PHPMailer\Exception;

require __DIR__ . '/assets/lib//vendor/autoload.php';
require_once 'config/database.php';

// Configurazione
$GIORNI_PREAVVISO = 30; // Giorni di preavviso per le notifiche
$EMAIL_ADMIN = 'admin@tuodominio.com'; // Email amministratore
$NOME_SISTEMA = 'Sistema Gestionale';

// Log file per tenere traccia delle esecuzioni
$LOG_FILE = __DIR__ . '/logs/scadenze_' . date('Y-m') . '.log';

/**
 * Funzione per scrivere nel log
 */
function writeLog($message) {
    global $LOG_FILE;
    
    $log_dir = dirname($LOG_FILE);
    if (!is_dir($log_dir)) {
        mkdir($log_dir, 0755, true);
    }
    
    $timestamp = date('Y-m-d H:i:s');
    $log_entry = "[$timestamp] $message" . PHP_EOL;
    file_put_contents($LOG_FILE, $log_entry, FILE_APPEND | LOCK_EX);
    
    // Output anche su console se eseguito da CLI
    if (php_sapi_name() === 'cli') {
        echo $log_entry;
    }
}

/**
 * Configura e restituisce istanza PHPMailer
 */
function getMailerInstance() {
    $mail = new PHPMailer(true);
    
    try {
        // Configurazione server Mailjet
        $mail->isSMTP();
        $mail->Host       = 'in-v3.mailjet.com';
        $mail->SMTPAuth   = true;
        $mail->Username   = '14de26fbf5928362f092f82407cf6c1c';
        $mail->Password   = '9ecf49a7e10b8b4bbb2812aeb66826ab';
        $mail->SMTPSecure = 'ssl';
        $mail->Port       = 465;
        
        return $mail;
    } catch (Exception $e) {
        writeLog("ERRORE configurazione PHPMailer: " . $e->getMessage());
        return null;
    }
}

/**
 * Invia email di notifica
 */
function sendNotificationEmail($destinatario, $nome_destinatario, $oggetto, $corpo) {
    global $NOME_SISTEMA;
    
    $mail = getMailerInstance();
    if (!$mail) return false;
    
    try {
        $mail->setFrom('14de26fbf5928362f092f82407cf6c1c', $NOME_SISTEMA);
        $mail->addAddress($destinatario, $nome_destinatario);
        
        $mail->isHTML(true);
        $mail->Subject = $oggetto;
        $mail->Body = $corpo;
        
        $mail->send();
        writeLog("Email inviata con successo a: $destinatario");
        return true;
        
    } catch (Exception $e) {
        writeLog("ERRORE invio email a $destinatario: " . $e->getMessage());
        return false;
    }
}

/**
 * Controlla scadenze domini
 */
function checkDomainExpiry() {
    global $GIORNI_PREAVVISO;
    
    writeLog("Inizio controllo scadenze domini...");
    $connessione = getDBConnection();
    
    // Query per trovare domini in scadenza (aggiungi 1 anno alla data di registrazione)
    $sql = "SELECT d.*, u.Email, u.Nome, u.azienda 
            FROM domini d 
            JOIN utenti u ON d.id_utente = u.ID 
            WHERE DATE_ADD(d.data_registrazione, INTERVAL 1 YEAR) <= DATE_ADD(CURDATE(), INTERVAL ? DAY)
            AND DATE_ADD(d.data_registrazione, INTERVAL 1 YEAR) >= CURDATE()
            AND u.attivo = 'true'";
    
    $stmt = $connessione->prepare($sql);
    $stmt->bind_param("i", $GIORNI_PREAVVISO);
    $stmt->execute();
    $result = $stmt->get_result();
    
    $domini_scadenza = 0;
    
    while ($row = $result->fetch_assoc()) {
        $data_scadenza = date('Y-m-d', strtotime($row['data_registrazione'] . ' +1 year'));
        $giorni_rimanenti = ceil((strtotime($data_scadenza) - time()) / (60*60*24));
        
        $oggetto = "‚ö†Ô∏è AVVISO: Dominio in scadenza - " . $row['nome_dominio'];
        
        $corpo = "
        <div style='font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;'>
            <div style='background-color: #f8f9fa; padding: 20px; border-left: 5px solid #dc3545;'>
                <h2 style='color: #dc3545; margin-top: 0;'>
                    üö® AVVISO DI SCADENZA DOMINIO
                </h2>
                
                <p><strong>Gentile {$row['Nome']},</strong></p>
                
                <p>Il dominio <strong style='color: #dc3545;'>{$row['nome_dominio']}</strong> 
                registrato per la sua azienda <strong>{$row['azienda']}</strong> 
                √® in scadenza.</p>
                
                <div style='background-color: #fff; padding: 15px; margin: 20px 0; border-radius: 5px;'>
                    <h3 style='margin-top: 0; color: #495057;'>Dettagli Scadenza:</h3>
                    <ul style='list-style: none; padding: 0;'>
                        <li><strong>Dominio:</strong> {$row['nome_dominio']}</li>
                        <li><strong>Data registrazione:</strong> " . date('d/m/Y', strtotime($row['data_registrazione'])) . "</li>
                        <li><strong>Data scadenza:</strong> <span style='color: #dc3545;'>" . date('d/m/Y', strtotime($data_scadenza)) . "</span></li>
                        <li><strong>Giorni rimanenti:</strong> <span style='color: #dc3545; font-weight: bold;'>{$giorni_rimanenti}</span></li>
                    </ul>
                </div>
                
                <div style='background-color: #fff3cd; padding: 15px; margin: 20px 0; border-radius: 5px; border: 1px solid #ffeaa7;'>
                    <h4 style='margin-top: 0; color: #856404;'>‚ö° Azione Richiesta:</h4>
                    <p style='margin-bottom: 0;'>
                        Vi invitiamo a contattare il vostro amministratore di sistema 
                        per procedere con il rinnovo del dominio prima della scadenza.
                    </p>
                </div>
                
                <p style='margin-bottom: 0;'>
                    <em>Questo √® un messaggio automatico del sistema di gestione domini.</em><br>
                    <small>Data invio: " . date('d/m/Y H:i:s') . "</small>
                </p>
            </div>
        </div>";
        
        if (sendNotificationEmail($row['Email'], $row['Nome'], $oggetto, $corpo)) {
            $domini_scadenza++;
        }
    }
    
    $stmt->close();
    $connessione->close();
    
    writeLog("Controllo domini completato. Notifiche inviate: $domini_scadenza");
    return $domini_scadenza;
}

/**
 * Controlla file non accessibili da tempo
 */
function checkOldFiles() {
    writeLog("Inizio controllo file obsoleti...");
    $connessione = getDBConnection();
    
    // Query per trovare file caricati da pi√π di 6 mesi e ancora disponibili
    $sql = "SELECT f.*, u.Email, u.Nome, u.azienda 
            FROM files f 
            JOIN utenti u ON f.id_utente = u.ID 
            WHERE f.data_upload <= DATE_SUB(CURDATE(), INTERVAL 6 MONTH)
            AND f.disponibile = 'true'
            AND u.attivo = 'true'";
    
    $result = $connessione->query($sql);
    $file_obsoleti = 0;
    
    while ($row = $result->fetch_assoc()) {
        $nome_file_pulito = substr($row['nome_file'], 11); // Rimuove timestamp
        
        $oggetto = "üìÅ Notifica: File caricato da tempo - " . $nome_file_pulito;
        
        $corpo = "
        <div style='font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;'>
            <div style='background-color: #f8f9fa; padding: 20px; border-left: 5px solid #17a2b8;'>
                <h2 style='color: #17a2b8; margin-top: 0;'>
                    üìÅ NOTIFICA FILE OBSOLETO
                </h2>
                
                <p><strong>Gentile {$row['Nome']},</strong></p>
                
                <p>Il file <strong>{$nome_file_pulito}</strong> √® stato caricato sul sistema 
                da pi√π di 6 mesi e potrebbe necessitare di una revisione.</p>
                
                <div style='background-color: #fff; padding: 15px; margin: 20px 0; border-radius: 5px;'>
                    <h3 style='margin-top: 0; color: #495057;'>Dettagli File:</h3>
                    <ul style='list-style: none; padding: 0;'>
                        <li><strong>Nome file:</strong> {$nome_file_pulito}</li>
                        <li><strong>Data caricamento:</strong> " . date('d/m/Y', strtotime($row['data_upload'])) . "</li>
                        <li><strong>Stato:</strong> <span style='color: #28a745;'>Disponibile</span></li>
                    </ul>
                </div>
                
                <div style='background-color: #d1ecf1; padding: 15px; margin: 20px 0; border-radius: 5px;'>
                    <h4 style='margin-top: 0; color: #0c5460;'>üí° Suggerimento:</h4>
                    <p style='margin-bottom: 0;'>
                        Verificare se il file √® ancora necessario. 
                        Se non pi√π utilizzato, considerare la rimozione per ottimizzare lo spazio.
                    </p>
                </div>
                
                <p style='margin-bottom: 0;'>
                    <em>Questo √® un messaggio informativo del sistema.</em><br>
                    <small>Data invio: " . date('d/m/Y H:i:s') . "</small>
                </p>
            </div>
        </div>";
        
        if (sendNotificationEmail($row['Email'], $row['Nome'], $oggetto, $corpo)) {
            $file_obsoleti++;
        }
    }
    
    $connessione->close();
    
    writeLog("Controllo file completato. Notifiche inviate: $file_obsoleti");
    return $file_obsoleti;
}

/**
 * Invia report giornaliero all'admin
 */
function sendDailyReport($domini_scadenza, $file_obsoleti) {
    global $EMAIL_ADMIN, $NOME_SISTEMA;
    
    writeLog("Invio report giornaliero all'amministratore...");
    
    $oggetto = "üìä Report Giornaliero Scadenze - " . date('d/m/Y');
    
    $corpo = "
    <div style='font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;'>
        <div style='background-color: #f8f9fa; padding: 20px; border-left: 5px solid #28a745;'>
            <h2 style='color: #28a745; margin-top: 0;'>
                üìä REPORT GIORNALIERO SISTEMA
            </h2>
            
            <p><strong>Data:</strong> " . date('d/m/Y H:i:s') . "</p>
            
            <div style='background-color: #fff; padding: 20px; margin: 20px 0; border-radius: 5px;'>
                <h3 style='margin-top: 0; color: #495057;'>Riepilogo Attivit√†:</h3>
                
                <div style='display: flex; justify-content: space-between; margin: 15px 0; padding: 10px; background-color: #f8f9fa; border-radius: 5px;'>
                    <span><strong>üåê Domini in scadenza:</strong></span>
                    <span style='color: " . ($domini_scadenza > 0 ? '#dc3545' : '#28a745') . "; font-weight: bold;'>{$domini_scadenza}</span>
                </div>
                
                <div style='display: flex; justify-content: space-between; margin: 15px 0; padding: 10px; background-color: #f8f9fa; border-radius: 5px;'>
                    <span><strong>üìÅ File obsoleti:</strong></span>
                    <span style='color: " . ($file_obsoleti > 0 ? '#ffc107' : '#28a745') . "; font-weight: bold;'>{$file_obsoleti}</span>
                </div>
            </div>
            
            <div style='background-color: " . ($domini_scadenza > 0 || $file_obsoleti > 0 ? '#fff3cd' : '#d4edda') . "; 
                        padding: 15px; margin: 20px 0; border-radius: 5px;'>
                <h4 style='margin-top: 0; color: " . ($domini_scadenza > 0 || $file_obsoleti > 0 ? '#856404' : '#155724') . ";'>
                    " . ($domini_scadenza > 0 || $file_obsoleti > 0 ? '‚ö†Ô∏è Attenzione Richiesta' : '‚úÖ Tutto OK') . "
                </h4>
                <p style='margin-bottom: 0;'>
                    " . ($domini_scadenza > 0 || $file_obsoleti > 0 ? 
                        'Sono state rilevate scadenze o elementi che necessitano attenzione.' : 
                        'Nessuna scadenza critica rilevata oggi.') . "
                </p>
            </div>
            
            <p style='margin-bottom: 0;'>
                <em>Report automatico del {$NOME_SISTEMA}</em><br>
                <small>Log completo disponibile in: logs/scadenze_" . date('Y-m') . ".log</small>
            </p>
        </div>
    </div>";
    
    sendNotificationEmail($EMAIL_ADMIN, 'Amministratore', $oggetto, $corpo);
}

// ==========================================
// ESECUZIONE PRINCIPALE DELLO SCRIPT
// ==========================================

writeLog("=== INIZIO CONTROLLO SCADENZE AUTOMATICO ===");

try {
    // Controllo domini in scadenza
    $domini_scadenza = checkDomainExpiry();
    
    // Controllo file obsoleti
    $file_obsoleti = checkOldFiles();
    
    // Invio report giornaliero all'admin
    sendDailyReport($domini_scadenza, $file_obsoleti);
    
    writeLog("=== CONTROLLO COMPLETATO CON SUCCESSO ===");
    writeLog("Totale notifiche inviate: " . ($domini_scadenza + $file_obsoleti));
    
} catch (Exception $e) {
    writeLog("ERRORE CRITICO: " . $e->getMessage());
    
    // Invia email di errore all'admin
    $error_mail = getMailerInstance();
    if ($error_mail) {
        try {
            $error_mail->setFrom('14de26fbf5928362f092f82407cf6c1c', $NOME_SISTEMA);
            $error_mail->addAddress($EMAIL_ADMIN);
            $error_mail->Subject = "üö® ERRORE Script Controllo Scadenze";
            $error_mail->Body = "
                <h3>Errore nell'esecuzione dello script di controllo scadenze</h3>
                <p><strong>Data/Ora:</strong> " . date('Y-m-d H:i:s') . "</p>
                <p><strong>Errore:</strong> " . htmlspecialchars($e->getMessage()) . "</p>
                <p>Controllare i log per maggiori dettagli.</p>";
            $error_mail->send();
        } catch (Exception $mail_error) {
            writeLog("ERRORE invio email di errore: " . $mail_error->getMessage());
        }
    }
}

writeLog("=== FINE ESECUZIONE SCRIPT ===");

// Se eseguito da browser, mostra risultati
if (php_sapi_name() !== 'cli') {
    echo "<html><head><title>Controllo Scadenze</title></head><body>";
    echo "<h2>Script Controllo Scadenze Eseguito</h2>";
    echo "<p>Controllare i log per i dettagli: <code>logs/scadenze_" . date('Y-m') . ".log</code></p>";
    echo "<p><a href='admin.php'>Torna al pannello admin</a></p>";
    echo "</body></html>";
}
?>